<html>
<head>
        <title>CoffeeChatter - v0.1</title>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.4.2.js"></script>
        <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.8/require.min.js"></script>
        <script type="text/javascript" src="js/jquery.titlealert.min.js"></script>
        <script type="text/javascript" src="js/dust-core-2.2.0.js"></script>
        <script type="text/javascript" src="js/socket.io.js"></script>
        <script type="text/javascript" src="js/bootstrap/js/bootstrap.js"></script>
        <script type="text/javascript" src="js/compiled/coffeecommand.js"></script>
        <script type="text/javascript" src="js/compiled/msg.js"></script>
        <script type="text/javascript" src="js/compiled/commands.js"></script>
        <script type="text/javascript" src="js/compiled/userlist.js"></script>
        <script type="text/javascript" src="js/compiled/voted.js"></script>
        <link href="/js/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
        <link rel="stylesheet" type="text/css" href="css/coffeechatter.css">
</head>
<body>
<div class="container">
        <div class="row">
            <p></p>
        </div>
        <div class="row" id="loginRow">
            <div class="span6">
                <input id="nick" class="nickInput" type="text" placeholder="Username..."/>
                <input id="email" class="emailInput" type="text" placeholder="Email (for gravatar)..."/>
            </div>
            <div class="span1">
                 <button id="login" class="btn btn-primary">Login</button>
            </div>
        </div>
        <div class="row " id="composeRow">
            <div class="span2" >
                
            </div>
            <div class="input-group">
                <div class="span4">
                    <div>
                        <input id="msgInput" type="text" class="msgInput form-control input-sm" placeholder="Type your message here..." autofocus/>
                    </div>
                </div>
                <div class="span2" >
                    <span class="input-group-btn">
                        <button class="btn btn-warning btn-sm" id="send">Send</button>
                    </span> 
                </div>
            </div>
        </div>
        <div class="row">
            <div class="span2" id="users">
                
            </div>
               <div class="span4" id="messages"> 
                
               </div>
            <div class="span2" id="commands">
                
            </div>
        </div>
</div>
        <script>
                var commands = {
                    commands:[
                        { id: 0, name: "I want coffee", type: "stmt", class:"label-info"},
                        { id: 1, name: "Who wants coffee?", type: "vote", class:"label-success", choices:['Yes','No']},
                        { id: 2, name: "Coffee Brewing", type: "stmt", class:"label-warning"},
                        { id: 3, name: "Coffee Ready", type: "stmt", class:"label-important"},
                        { id: 4, name: "We are out of coffee", type: "stmt", class:"label-important"},
                        { id: 5, name: "Lunch?", type: "vote", class:"label-success", choices:['Yes','No']},
                        { id: 6, name: "Foos?", type: "vote", class:"label-success", choices:['Yes','No']},
                        { id: 7, name: "Baristas?", type: "vote", class:"label-success", choices:['Yes','No']}
                    ]
                };
                dust.render("commands",commands,function(err,out){$('#commands').append(out)});
             var socket = null;
             function connect(nick,email){
                  var server = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ":"+window.location.port : "");
                  socket = io.connect(server);
                  socket.on('connect', function () {
                    socket.emit('adduser', nick, email);
                  });
                  socket.on('coffeecommand', function (data) {
                    console.log(data);
                    dust.render("coffeecommand",data,function(err,out){$('#messages').prepend(out)});
                    if(nick != data.user.nick){
                        //$.titleAlert('New Coffee Command');
                        notify(data.user, data.user.nick,data.name, data.history);
                    }
                  });
                  socket.on('msg', function (data) {
                    console.log(data);
                    dust.render("msg",data,function(err,out){$('#messages').prepend(out)});
                    var msg = data.msg;
                    if(data.announce){
                        msg = data.announce;
                    }
                    if(nick != data.user.nick){
                        notify(data.user, data.user.nick, msg, data.history);
                    }
                  });
                  socket.on('updateusers', function (data) {
                    console.log(data);
                    var users = {users:data};
                    $('#users').empty();
                    dust.render("userlist",users,function(err,out){$('#users').append(out)});
                  });
                  socket.on('voted',function(data){
                    console.log(data);
                    dust.render("voted",data,function(err,out){$('#vote-responses-for-vote-'+data.voteid+'-'+data.vote).append(out)});
                    notify(data.user, data.user.nick,data.vote + " for " + data.votename, data.history);
                  });
            }

            var focused = true;

            window.onfocus = function() {
                focused = true;
            };
            window.onblur = function() {
                focused = false;
            };
            
            function notify(user, title, message, historical){
                historical = (typeof historical !== 'undefined') ? historical : false;
                if(focused == false && historical == false){
                    if (window.webkitNotifications.checkPermission() == 0) { // 0 is PERMISSION_ALLOWED
                        var notification = window.webkitNotifications.createNotification(user.gravatar, title, message);
                        notification.show();
                        setTimeout(function(){
                            notification.cancel()
                        }, 1000*30);
                    }
                }
            }

            $(function(){
                $('#login').click(function(){
                    var nick = $('#nick').val();
                    var email = $('#email').val();
                    $('#loginRow').remove();
                    
                    connect(nick,email);

                    if (window.webkitNotifications) {
                      console.log("Notifications are supported!");
                      if (window.webkitNotifications.checkPermission() != 0) {
                           window.webkitNotifications.requestPermission();
                      }
                    } else {
                      console.log("Notifications are not supported for this Browser/OS version yet.");
                    }
                });
            // when the client clicks SEND
            $('#send').click( function() {
                var message = $('#msgInput').val();
                $('#msgInput').val('');
                $('#msgInput').focus();
                // tell server to execute 'sendchat' and send along one parameter
                socket.emit('msg', {msg:message});
            });

            // when the client hits ENTER on their keyboard
            $('#msgInput').keypress(function(e) {
                if(e.which == 13) {
                    $(this).blur();
                    $('#send').focus().click();
                }
            });
        });
        var coffeecommand = function(command){
            socket.emit('coffeecommand',command);
        };
        var vote = function(voteid, vote, votename){
            console.log("voting for "+vote+ " on voteid "+voteid+", "+votename);
            socket.emit('vote',{voteid:voteid, vote:vote, votename:votename});
        };
        </script>
</body>
</html>
